#include <assert.h>
#include <gsl/gsl_interp2d.h>
#include <math.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdlib.h>

#include <gsl/gsl_math.h>
#include <gsl/gsl_sf_gamma.h>
#include <gsl/gsl_linalg.h>

#include "basics.h"
#include "halo.h"
#include "recompute.h"
#include "structs.h"
#include "tinker_emulator.h"

#include "log.c/src/log.h"

static double emu_tinker_bias_y[40][4] = {
    {0.22772415000000001,-0.37692982250000007,-0.0402944999999999,0.04022747500000001},
    {-0.28278585,0.19515017749999994,0.04740549999999999,-0.06182552499999994},
    {0.3212841500000001,-0.8808398225,-0.11989450000000001,0.06898547500000007},
    {0.17846414999999993,-0.6810798225000001,-0.09233449999999999,0.05497347500000005},
    {0.4098541499999999,-0.5539598225000001,-0.07733450000000008,0.0647434750000001},
    {-0.76878285,0.5381131774999999,0.08117550000000007,-0.06465652499999996},
    {0.40140415000000007,-0.5459038225,-0.08968449999999994,0.08774847500000005},
    {0.24942415000000007,0.026990177499999934,-0.019294499999999992,0.03807147500000008},
    {-0.39614284999999994,0.11911017749999997,0.04924550000000005,-0.06747352499999992},
    {0.3164341500000001,-0.16069982250000003,-0.03416449999999993,0.033380475000000076},
    {-0.2499258499999999,0.5025871774999999,0.06269550000000002,-0.06842252499999996},
    {-0.12223585000000003,-0.3533408225000001,-0.03049450000000009,0.017900475000000027},
    {0.2607141500000001,-0.11666582250000002,-0.012854499999999991,0.03635147500000002},
    {0.08741415000000008,0.26517217749999994,0.04785550000000005,-0.043800524999999924},
    {-0.76097985,0.24849317749999994,0.05062549999999999,-0.022498524999999936},
    {-0.06336585000000006,0.5376801775,0.07865549999999999,-0.07991652499999996},
    {-0.09263584999999996,0.46694977749999994,0.041795500000000096,-0.038999524999999924},
    {-0.06395584999999993,0.5896181775,0.06771550000000004,-0.06875352499999993},
    {0.37515414999999996,0.3734211774999999,0.02701550000000008,0.015070475000000028},
    {0.37989414999999993,0.42874727749999997,0.04378550000000003,-0.012818524999999914},
    {0.04260415000000006,-0.06311582250000008,0.01377549999999994,-0.017001524999999962},
    {0.15116415000000005,-0.18857682250000007,-0.031214499999999923,0.028068475000000093},
    {-0.46622184999999994,-0.00875982250000007,0.025565499999999908,-0.020490524999999926},
    {0.9793741499999999,-1.4424998225,-0.23205450000000005,0.1436824750000001},
    {0.5773441500000001,-0.40441882250000005,-0.06932450000000001,0.07315647500000011},
    {-0.0900458500000001,0.05627017749999996,-0.0025844999999999896,0.0005704750000000702},
    {-0.43227585,0.15328717749999995,0.048885499999999915,-0.061249524999999916},
    {0.06163414999999994,0.17322317749999994,0.002195500000000017,0.002554475000000056},
    {-1.11435885,0.6018431774999999,0.10177550000000002,-0.051648524999999945},
    {-0.58425185,0.33632737749999997,0.06437549999999992,-0.06131052499999995},
    {-0.05438585000000007,0.5742031774999999,0.06327550000000004,-0.05677052499999996},
    {-0.46905785,0.5551571774999999,0.08878549999999996,-0.09477352499999991},
    {0.48297415,0.06671617749999992,-0.005604500000000012,0.03804847500000008},
    {0.10267414999999991,-0.12002582250000005,-0.021424499999999957,0.03506147500000001},
    {-0.2600958499999999,0.08162417749999995,0.021935500000000108,-0.03365652499999994},
    {0.7054041500000001,-1.0345198225,-0.15660450000000004,0.13090447500000002},
    {-0.49813684999999996,0.16804117749999994,0.04431549999999995,-0.04419252499999993},
    {-0.10155585,-0.29502082250000006,-0.039974500000000024,0.02313947500000002},
    {0.2226541500000001,0.20897417749999994,-0.0015045000000000197,0.01563147500000006},
    {0.33760415,-0.04134282250000004,0.003785499999999997,0.021988475000000007}
};

static double emu_tinker_bias_ymean[4] = {
    1.30796585, -0.39295018, -1.1741355 ,  0.52458352
};

static double emu_tinker_bias_cosmopars[40][7] = {
    {0.02268325,0.1140598,-0.8165972,0.975589,0.7730715,63.36569,2.91875},
    {0.02245071,0.1172576,-1.13444,0.9765227,0.8954628,73.09972,3.17375},
    {0.0229982,0.1087487,-0.6846595,0.9974496,0.6929467,63.70848,3.25875},
    {0.0226759,0.1123064,-0.7437379,0.9480812,0.6715524,64.04189,3.55625},
    {0.02208455,0.1062517,-0.7666051,0.9650928,0.749058,65.04913,2.66375},
    {0.02066455,0.1295035,-1.326359,0.9278462,0.9339844,72.75418,2.96125},
    {0.02294146,0.1115033,-0.7103081,0.9706424,0.7103632,62.69873,2.70625},
    {0.02281365,0.1195969,-0.8666033,0.9662983,0.7778608,64.37164,3.93875},
    {0.02067695,0.1238351,-1.163731,0.9491313,0.8919908,69.39996,3.59875},
    {0.0213439,0.1158135,-0.830933,0.9475234,0.7220269,62.35637,3.89625},
    {0.02189334,0.1289506,-1.241154,0.9610168,0.8497577,72.08599,4.23625},
    {0.02262122,0.1089506,-0.8609277,0.9960324,0.8055318,67.73404,2.83375},
    {0.02250605,0.1167658,-0.8794716,0.9539512,0.7851298,65.37987,2.87625},
    {0.02189555,0.1171763,-1.119505,0.9788153,0.8660544,71.08341,3.00375},
    {0.02264907,0.127108,-1.116826,0.9723654,0.9232811,68.73003,2.74875},
    {0.0214676,0.1285016,-1.302908,0.9335675,0.9078274,74.10001,3.72625},
    {0.02177406,0.1206762,-1.131299,0.9662156,0.8069646,70.07432,3.76875},
    {0.02228121,0.1194239,-1.24807,0.9519719,0.8695022,74.43912,3.21625},
    {0.02287409,0.1157403,-1.032177,0.9533103,0.7356345,70.75163,4.27875},
    {0.0223826,0.1132626,-1.091607,0.9672909,0.8083719,72.42955,3.68375},
    {0.02225371,0.122488,-0.9898374,0.9528876,0.8378528,67.05524,3.38625},
    {0.02361513,0.117169,-0.8658316,0.9757853,0.7617592,66.389,3.85375},
    {0.02153845,0.121009,-1.031605,0.9585567,0.880451,68.0619,2.62125},
    {0.0227263,0.1012181,-0.5658486,0.9745746,0.5746315,62.0335,3.47125},
    {0.02245361,0.1102766,-0.7614561,0.958918,0.6918467,63.03209,4.15125},
    {0.02092906,0.1170569,-0.9478782,0.9344636,0.7900302,65.71267,3.08875},
    {0.02236205,0.1191811,-1.125103,0.9442601,0.9043988,71.75536,2.79125},
    {0.02135801,0.1134255,-0.9645883,0.9663881,0.7285257,67.39297,4.02375},
    {0.02174718,0.1317768,-1.399921,0.9585702,0.9644551,74.76752,3.81125},
    {0.0223248,0.1289151,-1.236071,0.9401456,0.9344431,71.41356,3.42875},
    {0.02192792,0.1239137,-1.223681,0.9552358,0.8682105,73.43152,4.06625},
    {0.02123964,0.1275787,-1.381645,0.9560725,0.9417921,73.75997,3.34375},
    {0.02249688,0.112845,-0.9257578,0.9494842,0.7208264,68.40342,3.98125},
    {0.02337319,0.1149703,-0.8752207,0.9891731,0.7771575,66.05231,3.64125},
    {0.02275573,0.1222293,-1.03229,0.9500281,0.8576372,69.07038,3.13125},
    {0.02341077,0.1076406,-0.6128197,0.9955676,0.6845285,61.69472,3.04625},
    {0.02199894,0.1212967,-1.108222,0.967361,0.9050606,70.41129,3.30125},
    {0.02287447,0.109744,-0.8487455,0.9776227,0.7255155,66.7262,3.51375},
    {0.02371239,0.1149747,-0.9550075,0.9765907,0.7368773,69.7468,4.10875},
    {0.02174072,0.12007,-0.9410529,0.9602072,0.7613921,64.7043,4.19375},
};

static double emu_tinker_bias_variances[40][4] = {
    {0.0072293,0.00439722,2.81818e-06,4.74412e-05},
    {0.00699877,0.00269795,7.42337e-07,2.39677e-05},
    {0.0110443,0.00711122,4.65542e-06,0.000112801},
    {0.0106216,0.0102302,4.31172e-06,0.000103383},
    {0.00724683,0.00524066,4.31665e-06,6.43917e-05},
    {0.0106784,0.00234987,5.0869e-06,6.98768e-05},
    {0.00854694,0.00664262,5.57295e-06,8.14472e-05},
    {0.00686848,0.0047873,3.72477e-06,5.69853e-05},
    {0.00724118,0.00248583,8.77754e-07,2.31016e-05},
    {0.00877297,0.00692596,6.01501e-06,9.17487e-05},
    {0.00627794,0.00336004,9.26898e-07,2.86192e-05},
    {0.00788265,0.00320692,8.60393e-07,2.75182e-05},
    {0.00645664,0.00441144,3.48456e-06,5.00461e-05},
    {0.00516963,0.0030301,1.88609e-06,2.83136e-05},
    {0.00627674,0.002754,3.41576e-06,5.52287e-05},
    {0.00476999,0.00279074,1.30704e-06,2.45841e-05},
    {0.00625622,0.00428272,1.611e-06,3.75563e-05},
    {0.00486567,0.00359014,1.30515e-06,2.83193e-05},
    {0.00793602,0.00820381,8.56658e-06,0.000112397},
    {0.00547263,0.00462295,5.10187e-06,6.12737e-05},
    {0.00639258,0.00334604,1.60622e-06,3.16773e-05},
    {0.00728083,0.00523552,2.64198e-06,5.18353e-05},
    {0.0114682,0.00289903,2.18067e-06,3.56099e-05},
    {0.0289611,0.0255266,5.05678e-05,0.000513587},
    {0.0115307,0.00948345,1.29089e-05,0.000154464},
    {0.00693994,0.00459213,1.46837e-06,3.85683e-05},
    {0.00863687,0.00262847,1.12103e-06,2.78236e-05},
    {0.00777637,0.00787936,3.47484e-06,7.01753e-05},
    {0.00742029,0.00223942,1.12076e-05,0.000137364},
    {0.00756381,0.00224989,1.71963e-06,3.86059e-05},
    {0.00491035,0.00316571,1.4925e-06,3.04492e-05},
    {0.00734602,0.00208953,8.32388e-07,2.69424e-05},
    {0.00901434,0.00916022,1.04109e-05,0.000133636},
    {0.0066438,0.00432074,2.23461e-06,4.61122e-05},
    {0.00686723,0.00277957,7.85587e-07,2.64958e-05},
    {0.0119653,0.00774551,1.07802e-05,0.000130799},
    {0.00885545,0.00250722,1.62889e-06,3.42051e-05},
    {0.00961551,0.00626229,1.51812e-06,4.70177e-05},
    {0.00691408,0.00685252,4.84129e-06,7.6411e-05},
    {0.00646323,0.00500426,4.99086e-06,6.97103e-05}
};

static double emu_tinker_bias_rotation_matrix[4][4] = {
    {0.10646337980893085,0.021132636136643016,-0.97064255773295,-0.21464385751102177},
    {-0.978398102331227,-0.14405378008966646,-0.08332901175552901,-0.12264557715783554},
    {0.168930091936486,-0.9427314540214435,0.060196305393736965,-0.28124088332582375},
    {-0.053528741369879666,-0.3000988599285399,-0.21745276667457572,0.9272484253869187}
};


static double emu_tinker_bias_log_lambda[4][7] = {
    {-7.447915268014326,-7.464755353609271,-2.599556684860801,-5.8827162885183135,-3.4939080354809984,22.358830230679345,2.032157502031441},
    {-8.23942986061086,13.078292333315005,-1.6453454526931253,24.55006207730737,-2.208502981716542,6.529841736884682,2.702316841471984},
    {-2.3990180929022267,-4.984895914479709,0.6207751414355313,24.725128904515856,6.6630793421725425,6.460552261861607,5.096751130041617},
    {-4.200230133222608,-3.9710113322602116,2.102438559177407,23.3325814549079,5.148802333913723,10.75333618297953,9.909683276181012},
};


static double  emu_tinker_hmf_y[40][6] = {
   {0.12483946755290232,-0.005238403599061803,-0.024025363457128357,-0.005027131227518078,-0.01032434704017876,-0.0036486614705617537},
    {0.10090383050585269,-0.1222524725067109,-0.1015335679290148,0.007057719109299754,-0.006478379223565034,-0.01147454806304915},
    {0.0376465822491692,0.06109261865214552,0.042695144733237544,0.004805512031677672,-0.009236446085235106,0.0019516063512456938},
    {0.1390082116232415,0.030918294172957023,-0.013063444815985203,0.020603170194710363,0.004502517104585491,0.0064926447081699035},
    {-0.16392351992285695,-0.05536933629094315,-0.007607712318566495,0.010530019710359828,-0.014467804472507395,0.0031600212733615685},
    {-0.21002244807097717,-0.07606838159063806,-0.11245276532261195,-0.018348079199443146,-0.0035151984578517537,-0.0033868074283722738},
    {-0.0882059275316022,0.012990317535011453,0.01900138837474019,-0.010289149253091212,-0.016850974382830064,-0.0032406473891248844},
    {-0.1738395066636462,0.10702187227960483,0.09503953044360614,0.007604199917287335,0.003726632077329317,0.00031830289828249647},
    {0.025124973298932762,0.03441562134224033,-0.021596565090576947,-0.003148428211893761,0.003092695555990954,0.0009481079871747067},
    {0.49154411328731784,0.047731180925985245,0.047013155078408086,-0.003021900576107739,0.0115145481377244,0.007631063981359043},
    {-0.27981351800357357,0.03440639585121105,0.02876680918183183,0.009012935640745678,0.01264638760936121,0.003933753613907687},
    {-0.11204680093861866,-0.055870078314086025,0.001222759836295717,0.004310791164784833,-0.014097313558737501,-0.0034833982214348413},
    {-0.04418553158215918,0.009785032873205618,0.01295002049937799,-0.008820840276107966,-0.007873893143314492,0.002742621575825943},
    {0.007231809110213483,-0.06667945837358014,-0.03473126896026635,-0.0080606218008894,-0.005337640697108237,-0.003223298797547791},
    {-0.13705329669402547,-0.07821375619099485,-0.08256041331084085,-0.024166581447876312,-0.013723279731712501,-0.015033648098536245},
    {-0.2420163005686274,0.032267756449510354,-0.005406322771105643,0.009481376451594747,0.008678565488435208,0.00944389502589571},
    {-0.19469423911781594,0.0919182598677632,0.07005406221536703,0.0028317038874325906,0.007978877653283811,0.0027660787060583836},
    {-0.07666837760254216,-0.05121521699303061,-0.045235286187502055,-0.0037778449839400707,0.0006337326173014857,-0.00227320815457821},
    {0.2597484804568609,0.07690059931711854,0.09762183213584974,-0.0009465680262474852,0.019211887835976993,0.008244890076947176},
    {0.016573521782385386,-0.01501061479555632,0.021227866912737037,0.008922206546409184,0.0062461343237398825,0.001826379767882358},
    {0.03474052896710694,-0.047817252951956546,-0.061206062368540426,0.004391875712083215,-0.0010698414303856874,0.0005681742069547635},
    {0.3853403132708749,0.025728463196591195,0.017698612591384055,0.001364579934561072,0.0033804985683859035,-0.006284519878222206},
    {-0.1422518399239586,-0.08590542423557956,-0.08241665466637582,-0.0144309710831384,-0.012508864019247723,-0.005314401669416879},
    {0.156159980841883,0.18284184417387297,0.13632942369953938,-0.014970087377911723,-0.007915888499012702,0.0037187931787086015},
    {0.3133959574189187,0.01897440136227449,0.011565656107747735,0.025399563827985583,0.012428828451340135,0.009766642090977662},
    {-0.1605344116610937,-0.008164140510582174,0.0025289640796495316,-0.002378428527695098,-0.00262943038302349,0.0020825932883636877},
    {-0.018396477430914104,-0.10237078511779563,-0.031544268355344185,-0.018727064943670935,-0.007541915687938161,-0.002552407815211044},
    {0.32362397186999,0.022167187891648482,0.08029147110529433,-0.00041688106516635237,0.01567736672736736,0.013535395785731374},
    {-0.18112319092149567,-0.06937964389615514,-0.09177202568228027,-0.0036563083281970776,0.0028141304191649508,-0.011073220898633052},
    {-0.07157695439272913,-0.06393989976337183,-0.05429862610076319,-0.015408991178037179,-0.00038626851142486984,-0.0007176348692532475},
    {0.019284407076877147,-0.0006298180779013007,-0.03850639274622214,0.008417792104229549,0.009085141234618455,-0.003103968971533977},
    {-0.32992068874091907,-0.01999579356880138,-0.06369021216658988,-0.007554804854162822,0.0009495269069635937,-0.006053110181700294},
    {0.20926200995366168,0.06198936051441081,0.06632629731131101,0.012750567545677827,0.01297168635344148,0.0069619692088640495},
    {0.06238961546947211,0.027523436218074293,0.028542747413438208,0.0009335014383350382,-0.0029990365602304836,-0.005770448296088082},
    {-0.08434807291290772,-0.10663434650126657,-0.10013677662879483,0.0033065778867911177,-0.003385246974684619,-0.0020254639375865136},
    {-0.019444967184412715,0.02321847601172783,0.03854733432249735,-0.0006001156934988261,-0.016866193437044708,-0.0018206719151772077},
    {-0.30627895418312834,0.005946220408559272,-0.02648098743945293,-0.003976795886701079,-0.005049222656445973,-0.010199674836830486},
    {0.24792281850912468,-0.01668239576037367,0.03288233299625676,0.009282192785224685,0.002817384960992264,0.0045901939276300485},
    {0.11294964150549396,0.03997551665308596,0.07366480571602496,0.007618183678304247,0.011560559927982716,0.002998217667776748},
    {-0.03134521070227672,0.09962436334138594,0.07429450156337247,0.00910312437380334,0.012340082998493984,0.006998395571749194},
}; 
static double  emu_tinker_hmf_ymean[6] = {
    -0.20172192541916764,-0.25144522794491186,-1.0127003271736204,0.5479025200508498,-0.3748085109039096,-1.0756922694274775
};
static double  emu_tinker_hmf_cosmopars[40][7] = {
{0.02268325,0.1140598,-0.8165972,0.975589,0.7730715,63.36569,2.91875},
    {0.02245071,0.1172576,-1.13444,0.9765227,0.8954628,73.09972,3.17375},
    {0.0229982,0.1087487,-0.6846595,0.9974496,0.6929467,63.70848,3.25875},
    {0.0226759,0.1123064,-0.7437379,0.9480812,0.6715524,64.04189,3.55625},
    {0.02208455,0.1062517,-0.7666051,0.9650928,0.749058,65.04913,2.66375},
    {0.02066455,0.1295035,-1.326359,0.9278462,0.9339844,72.75418,2.96125},
    {0.02294146,0.1115033,-0.7103081,0.9706424,0.7103632,62.69873,2.70625},
    {0.02281365,0.1195969,-0.8666033,0.9662983,0.7778608,64.37164,3.93875},
    {0.02067695,0.1238351,-1.163731,0.9491313,0.8919908,69.39996,3.59875},
    {0.0213439,0.1158135,-0.830933,0.9475234,0.7220269,62.35637,3.89625},
    {0.02189334,0.1289506,-1.241154,0.9610168,0.8497577,72.08599,4.23625},
    {0.02262122,0.1089506,-0.8609277,0.9960324,0.8055318,67.73404,2.83375},
    {0.02250605,0.1167658,-0.8794716,0.9539512,0.7851298,65.37987,2.87625},
    {0.02189555,0.1171763,-1.119505,0.9788153,0.8660544,71.08341,3.00375},
    {0.02264907,0.127108,-1.116826,0.9723654,0.9232811,68.73003,2.74875},
    {0.0214676,0.1285016,-1.302908,0.9335675,0.9078274,74.10001,3.72625},
    {0.02177406,0.1206762,-1.131299,0.9662156,0.8069646,70.07432,3.76875},
    {0.02228121,0.1194239,-1.24807,0.9519719,0.8695022,74.43912,3.21625},
    {0.02287409,0.1157403,-1.032177,0.9533103,0.7356345,70.75163,4.27875},
    {0.0223826,0.1132626,-1.091607,0.9672909,0.8083719,72.42955,3.68375},
    {0.02225371,0.122488,-0.9898374,0.9528876,0.8378528,67.05524,3.38625},
    {0.02361513,0.117169,-0.8658316,0.9757853,0.7617592,66.389,3.85375},
    {0.02153845,0.121009,-1.031605,0.9585567,0.880451,68.0619,2.62125},
    {0.0227263,0.1012181,-0.5658486,0.9745746,0.5746315,62.0335,3.47125},
    {0.02245361,0.1102766,-0.7614561,0.958918,0.6918467,63.03209,4.15125},
    {0.02092906,0.1170569,-0.9478782,0.9344636,0.7900302,65.71267,3.08875},
    {0.02236205,0.1191811,-1.125103,0.9442601,0.9043988,71.75536,2.79125},
    {0.02135801,0.1134255,-0.9645883,0.9663881,0.7285257,67.39297,4.02375},
    {0.02174718,0.1317768,-1.399921,0.9585702,0.9644551,74.76752,3.81125},
    {0.0223248,0.1289151,-1.236071,0.9401456,0.9344431,71.41356,3.42875},
    {0.02192792,0.1239137,-1.223681,0.9552358,0.8682105,73.43152,4.06625},
    {0.02123964,0.1275787,-1.381645,0.9560725,0.9417921,73.75997,3.34375},
    {0.02249688,0.112845,-0.9257578,0.9494842,0.7208264,68.40342,3.98125},
    {0.02337319,0.1149703,-0.8752207,0.9891731,0.7771575,66.05231,3.64125},
    {0.02275573,0.1222293,-1.03229,0.9500281,0.8576372,69.07038,3.13125},
    {0.02341077,0.1076406,-0.6128197,0.9955676,0.6845285,61.69472,3.04625},
    {0.02199894,0.1212967,-1.108222,0.967361,0.9050606,70.41129,3.30125},
    {0.02287447,0.109744,-0.8487455,0.9776227,0.7255155,66.7262,3.51375},
    {0.02371239,0.1149747,-0.9550075,0.9765907,0.7368773,69.7468,4.10875},
    {0.02174072,0.12007,-0.9410529,0.9602072,0.7613921,64.7043,4.19375},
};
static double  emu_tinker_hmf_variances[40][6] = {
    {0.009318545482508829,0.0004246875675266332,0.00015487600545587712,2.694334671561682e-05,1.3778243833767651e-06,3.4022532459362735e-06},
    {0.006157997036870412,0.0004256398747375641,0.00015914282603571054,3.5563015116414026e-05,1.1056471197919879e-06,3.087445202314994e-06},
    {0.02068885717041575,0.000500888147956601,0.00021339618881687192,5.498788708327304e-05,1.5775858520781151e-06,4.0595950788550495e-06},
    {0.017417300193032142,0.0006509330398147242,0.00027052320455795125,5.047410878348989e-05,1.7904095680396041e-06,6.702897968876138e-06},
    {0.00870022688917163,0.0004209441920691669,0.0001942629431460059,2.8843740777292844e-05,1.290111943180096e-06,3.2446079706556714e-06},
    {0.006537499456627434,0.0004076819003012526,0.0001345609758378992,2.825975611360214e-05,1.2791158427977863e-06,3.095128066780945e-06},
    {0.012280466191341046,0.00048142850009117046,0.0002510922946013263,4.48969946138148e-05,2.129745840762816e-06,3.398245406976538e-06},
    {0.02003421147256665,0.0005293906448290946,0.00020413119769997114,0.00011980308704952807,1.3724644265290114e-06,6.092533221551995e-06},
    {0.010433607295920556,0.0004131684242054949,0.00015805707585226912,3.131568657900639e-05,1.0947184109994143e-06,3.4950108586852774e-06},
    {0.01761026611967291,0.000561002821742932,0.00018237702556837983,5.711512822806819e-05,1.1738307514034517e-06,4.514793462690834e-06},
    {0.009999279391730833,0.00047089528643424,0.00017823558149742313,4.8500882857593265e-05,1.182832211236942e-06,4.122526299849719e-06},
    {0.008117888417154773,0.00043341111370068686,0.00014069108743142842,3.2514817783215475e-05,1.6276875956938817e-06,2.7502890687849407e-06},
    {0.009591290160246362,0.00040089275971067644,0.00018351887554138183,4.087764615588688e-05,1.1103582834273505e-06,2.558671969662159e-06},
    {0.006998349110399623,0.0004821662452171618,0.0001633264108824825,2.806255850762561e-05,1.2035655657272317e-06,2.797296709705243e-06},
    {0.005705295686107662,0.0003930645813080258,0.00014013808536320635,2.6178754397298376e-05,1.199500730335225e-06,3.0793532768590435e-06},
    {0.01025223969447965,0.0005686323636704697,0.00014931062863969544,4.112780347044894e-05,1.1053576547357493e-06,4.4308891944629134e-06},
    {0.014278281973113482,0.0005341519820054954,0.00017490025192400322,8.063657463253709e-05,1.5833598359431886e-06,4.955760761024676e-06},
    {0.007988424607641676,0.0004201611591884818,0.00015997295907890647,3.54953109649642e-05,1.435194764543526e-06,3.474296420569453e-06},
    {0.021290890841452706,0.0005619762972853378,0.00018311986506916518,9.691065968495268e-05,1.2911123427042277e-06,5.667018364083435e-06},
    {0.009718709475259718,0.000541971541269579,0.00017293962162198288,3.952029210155498e-05,1.236627315425499e-06,3.60865427624257e-06},
    {0.008743136616981428,0.00041323070011352596,0.00015645540315248032,2.86673848571566e-05,9.013881831112326e-07,3.8069636583248696e-06},
    {0.01201269090808678,0.0005538302532358991,0.00015908510795692156,4.0641954454114565e-05,8.637641578054781e-07,3.5482422607571396e-06},
    {0.005426411859548728,0.00034526375485376793,0.0001316540516513562,2.4082561410026155e-05,8.876555145775118e-07,2.8879776968697306e-06},
    {0.04083059984458137,0.001131899154282332,0.00046054623381474425,0.00023065131460169348,3.925857407433231e-06,1.3865480538154231e-05},
    {0.017501609734322385,0.0005833682379866099,0.00024397910204320116,4.4856078174713805e-05,1.6525337856581345e-06,5.556218502028466e-06},
    {0.010390516556431993,0.0004321517228445344,0.00014557797784605386,4.113668434707366e-05,1.1620187350570828e-06,3.1367847886982928e-06},
    {0.007758133901549196,0.0004360568918815824,0.00015734860385301222,2.7807590270353622e-05,1.524364740811542e-06,3.1062598312518164e-06},
    {0.015834613752849416,0.0005257021573740107,0.00019391607506868286,6.602065205587146e-05,1.1949679917973644e-06,4.293156082151621e-06},
    {0.00578699214190892,0.0004034227396633457,0.00016421803882275384,3.145544310922225e-05,1.3068974705227331e-06,2.8639601902161935e-06},
    {0.00712763482736493,0.0004115276058595549,0.00014463999496927633,2.6099327007522964e-05,1.2999447161058692e-06,3.147203129561915e-06},
    {0.0087947499659553,0.000562861791914522,0.00015940359830321198,3.134936145816121e-05,1.0348792044383328e-06,3.3090258834658253e-06},
    {0.0064592217728499345,0.0004872838985905423,0.0001543001112470424,3.281707900194251e-05,1.5175325260757787e-06,4.095533830461945e-06},
    {0.014535448270271745,0.0006190984279276422,0.0002566376397593099,6.39199287646375e-05,1.2844879261192264e-06,4.095399120738143e-06},
    {0.013188626184973724,0.0004909520369320689,0.00016663823534539032,4.334161097152729e-05,1.1180522329980802e-06,3.331306200101487e-06},
    {0.00684970793938201,0.00038178924832734247,0.0001600925763312364,2.707016951299058e-05,1.460749807125942e-06,2.711700310226038e-06},
    {0.015187745681096994,0.0004945185309068278,0.00017689331355452784,5.1569041870925e-05,1.3090083606238858e-06,4.213044956429832e-06},
    {0.008932389077172876,0.00040035745263041443,0.00014810600986200296,3.0347824869653338e-05,9.65543977020444e-07,3.648452675579723e-06},
    {0.013420820543114945,0.00048167357377728226,0.00019410572814294503,4.3790484192128895e-05,1.3295726355414316e-06,4.579417713040836e-06},
    {0.01431468095562847,0.0005421372863853517,0.00019901837336642726,6.277556837398383e-05,1.1510624025018908e-06,3.847574448242543e-06},
    {0.014016862427958972,0.0005471466729146437,0.00017952248427574732,6.647117312998768e-05,8.644854505049425e-07,4.9362669652881555e-06},
};
static double  emu_tinker_hmf_rotation_matrix[6][6] = {
  {0.09970944582837364,-0.11553914547193866,-0.8146230937999444,0.38129376945558974,-0.3205356969119652,0.25489189022705966},
    {-0.03500286085171119,0.0758472472007383,0.2047188789551512,-0.040493014075545786,-0.9012495574960142,-0.3704345102011234},
    {0.015326981467150391,-0.02013945958050173,-0.3055115665594421,0.17371400527845235,0.2866788450961959,-0.890876451956006},
    {-0.9546577661603176,0.23110168435328649,-0.06436373419977898,0.17085706932240702,0.017983053808057627,0.03952647665832585},
    {-0.1479404127154394,-0.8395365948327658,0.302571473856566,0.42606685824741836,-0.011989785238413939,-0.008106835607497836},
    {-0.23524475250104485,-0.4714473677402052,-0.3247304902125365,-0.7823514016867839,-0.048520065111082776,-0.050194443499458626},
};
static double  emu_tinker_hmf_log_lambda[6][7] = {
 {9.636624142963997,-6.797551320540578,29.884854722968086,20.185588031416415,20.92767375513216,35.56403273544003,2.4908223914436607},
    {-4.440681824443147,-2.3859844906253334,10.142772817220115,2.8122555663614834,0.9011746887171654,14.973913127448919,6.034981341415424},
    {22.73361277829122,23.97594384003656,5.1899616697056565,2.5837536938899532,0.6063257956027144,31.49800258362801,6.556272478421314},
    {19.31675922011489,0.7043786053834887,26.521279089949683,25.01486560080846,23.31795753891555,37.262950393241375,8.622641578516253},
    {75.10669783390425,61.31522426083305,3.1131576942696486,4.557481491985718,5.281452078188849,33.72519890620941,7.979806866771378},
    {-6.897851924724379,87.96827245150186,24.53870076519068,-2.0474347496932555,1.6766687594129197,16.463931182039158,11.296527967723332},
};

static double emu_tinker_cosmopars_mean[7] = {0.0222629215,0.11783028750000005,-0.9965125425,0.9625151725000001,0.8055941174999999,68.231712,3.45};

static double emu_tinker_inv_covariance_cosmosample[6][6] = {
{33811972.28932342,-4989306.721181127,-418771.65354447835,-270715.6782219954,77582.04089097997,-14738.803088577642},
{-4989306.7211811105,2191061.9857309684,115297.19543213549,87919.5965202184,-67307.30178397016,4295.670961238579},
{-418771.6535444793,115297.19543213594,10428.363301542968,-1124.2385880611039,1127.1167055730104,335.6020489343281},
{-270715.67822199163,87919.59652021738,-1124.2385880611862,40549.45124308907,-8087.578201767655,38.91717391286996},
{77582.04089097871,-67307.3017839698,1127.1167055730427,-8087.578201767665,9766.55430463477,-57.15969177524984},
{-14738.80308857765,4295.670961238588,335.6020489343278,38.917173912872784,-57.15969177525089,12.183540589219549},
};

TinkerEmuParameters tinkerEmuParam =
{
  .tinker_bias_ncosmo = 7,                // do not change
  .tinker_bias_nparam = 4,                // do not change
  .tinker_bias_nsamp = 40, 
  .tinker_bias_nparam_redshift = 6,       // number of parameters of equation 7 in 1907.13167.;
  .tinker_hmf_ncosmo = 7,                 // do not change
  .tinker_hmf_nparam = 6,                 // do not change
  .tinker_hmf_nsamp = 40, 
  .tinker_hmf_nparam_redshift = 4,        // number of parameters of eq 2 in 1804.05866;
  .tinker_bias_extrapolation_cut_in = 40,
  .tinker_bias_extrapolation_cut_out = 45,
  .tinker_hmf_extrapolation_cut_in = 40,
  .tinker_hmf_extrapolation_cut_out = 45,
};

double kernel(const double *const x1, const double *const x2, const double *const loglambdas, 
const int ndim)
{ // Squared exponential kernel function
  double k=0.0;
  for (int i=0; i<ndim; ++i)
  { 
    k += (x1[i]- x2[i])*(x1[i]- x2[i])/(2*exp(loglambdas[i]));
  }
  return exp(-k);
}

void create_inverse_covariance_matrix(double *const *const sigma_x_x_inv, const int nparam, 
const int type)
{
  double (*cosmopars)[7];
  double (*loglambda)[7];
  int nsamp, ncosmo;
  switch(type)
  {
    case 0: //bias emulator 
      cosmopars = emu_tinker_bias_cosmopars; 
      loglambda = emu_tinker_bias_log_lambda;
      nsamp = tinkerEmuParam.tinker_bias_nsamp; 
      ncosmo = tinkerEmuParam.tinker_bias_ncosmo;
      break;
    case 1: //hmf emulator
      cosmopars = emu_tinker_hmf_cosmopars; 
      loglambda = emu_tinker_hmf_log_lambda;
      nsamp = tinkerEmuParam.tinker_hmf_nsamp; 
      ncosmo = tinkerEmuParam.tinker_hmf_ncosmo;
      break;
    default: 
      log_fatal("unkown type value %d (0 [bias emulator] or 1 [hmf emulator] supported)", type);
      exit(1);
  }
  gsl_matrix* cov  = gsl_matrix_calloc(nsamp, nsamp);
  if (cov == NULL)
  {
    log_fatal("fail allocation");
    exit(1);
  }
  gsl_matrix_set_zero(cov);
  for (int i=0; i<nsamp; ++i)
  {
    for (int j=0; j<nsamp; ++j)
    {
      double result = kernel(cosmopars[i], cosmopars[j], loglambda[nparam], ncosmo); 
      if (i == j)
      {
        if (type == 0) 
        {
          result += emu_tinker_bias_variances[i][nparam];
        }
        else if (type == 1)
        {
          //this is for white_noise agrument in the hmf emulator
          result += emu_tinker_hmf_variances[i][nparam];
          double mean_std = 0; 
          for (int k=0; k<nsamp; ++k)
          {
            mean_std += sqrt(emu_tinker_hmf_variances[k][nparam]); 
          } 
          mean_std /= (double) nsamp;
          result += pow(mean_std, 2);
        }
      }
      gsl_matrix_set(cov, i, j,result);
    } 
  }
  gsl_linalg_cholesky_decomp (cov);
  gsl_linalg_cholesky_invert(cov);
  for (int i=0; i<nsamp; ++i)
  {
    for (int j=0; j<nsamp; ++j)
    {
      sigma_x_x_inv[i][j] = gsl_matrix_get(cov, i, j);
    }
  } 
  gsl_matrix_free(cov);
}

double bias_emulate_single_param(const double *const cos, const int nparam)
{
  static double** sigma_x_x_inv0 = 0;
  static double** sigma_x_x_inv1 = 0;
  static double** sigma_x_x_inv2 = 0;
  static double** sigma_x_x_inv3 = 0;
  if (sigma_x_x_inv0 == 0)
  {
    const int nsize = tinkerEmuParam.tinker_bias_nsamp;
    sigma_x_x_inv0 = (double**) malloc(sizeof(double*)*(nsize+1));
    sigma_x_x_inv1 = (double**) malloc(sizeof(double*)*(nsize+1));
    sigma_x_x_inv2 = (double**) malloc(sizeof(double*)*(nsize+1));
    sigma_x_x_inv3 = (double**) malloc(sizeof(double*)*(nsize+1));
    for (int i=0; i<tinkerEmuParam.tinker_bias_nsamp+1;i++)
    {
      sigma_x_x_inv0[i] = (double*) malloc(sizeof(double)*(nsize+1));
      sigma_x_x_inv1[i] = (double*) malloc(sizeof(double)*(nsize+1));
      sigma_x_x_inv2[i] = (double*) malloc(sizeof(double)*(nsize+1));
      sigma_x_x_inv3[i] = (double*) malloc(sizeof(double)*(nsize+1));
    }
    create_inverse_covariance_matrix(sigma_x_x_inv0, 0, 0);
    create_inverse_covariance_matrix(sigma_x_x_inv1, 1, 0);
    create_inverse_covariance_matrix(sigma_x_x_inv2, 2, 0);
    create_inverse_covariance_matrix(sigma_x_x_inv3, 3, 0);
  }
  double** sigma_x_x_inv = 0;
  switch(nparam)
  {
    case 0: 
      sigma_x_x_inv = sigma_x_x_inv0; 
      break;
    case 1: 
      sigma_x_x_inv = sigma_x_x_inv1; 
      break;
    case 2: 
      sigma_x_x_inv = sigma_x_x_inv2; 
      break;
    case 3: 
      sigma_x_x_inv = sigma_x_x_inv3; 
      break;
    default:
      log_fatal("input nparam = %d (max %d)", nparam, tinkerEmuParam.tinker_bias_nparam);
      exit(0);
  }
  double result = 0;
  for (int i=0; i<tinkerEmuParam.tinker_bias_nsamp; ++i)
  {
    double temp = 0;
    for (int j=0; j<tinkerEmuParam.tinker_bias_nsamp; ++j)
    {
       temp += (sigma_x_x_inv)[i][j]*emu_tinker_bias_y[j][nparam]; 
    }
    temp *= kernel(cos, emu_tinker_bias_cosmopars[i], emu_tinker_bias_log_lambda[nparam], 
      tinkerEmuParam.tinker_bias_ncosmo);
    result += temp;
  }
  result += emu_tinker_bias_ymean[nparam];
  return result;
}

double hmf_emulate_single_param(const double *const cos, const int nparam)
{
  static double** sigma_x_x_inv0  = 0;
  static double** sigma_x_x_inv1  = 0;
  static double** sigma_x_x_inv2  = 0;
  static double** sigma_x_x_inv3  = 0;
  static double** sigma_x_x_inv4  = 0;
  static double** sigma_x_x_inv5  = 0;
  if (sigma_x_x_inv0 == 0)
  {
    const int nsize = tinkerEmuParam.tinker_hmf_nsamp;
    sigma_x_x_inv0 = (double**) malloc(sizeof(double*)*(nsize+1));
    sigma_x_x_inv1 = (double**) malloc(sizeof(double*)*(nsize+1));
    sigma_x_x_inv2 = (double**) malloc(sizeof(double*)*(nsize+1));
    sigma_x_x_inv3 = (double**) malloc(sizeof(double*)*(nsize+1));
    sigma_x_x_inv4 = (double**) malloc(sizeof(double*)*(nsize+1));
    sigma_x_x_inv5 = (double**) malloc(sizeof(double*)*(nsize+1));
    for (int i=0; i<tinkerEmuParam.tinker_bias_nsamp+1;i++)
    {
      sigma_x_x_inv0[i] = (double*) malloc(sizeof(double)*(nsize+1));
      sigma_x_x_inv1[i] = (double*) malloc(sizeof(double)*(nsize+1));
      sigma_x_x_inv2[i] = (double*) malloc(sizeof(double)*(nsize+1));
      sigma_x_x_inv3[i] = (double*) malloc(sizeof(double)*(nsize+1));
      sigma_x_x_inv4[i] = (double*) malloc(sizeof(double)*(nsize+1));
      sigma_x_x_inv5[i] = (double*) malloc(sizeof(double)*(nsize+1));
    }
    create_inverse_covariance_matrix(sigma_x_x_inv0, 0, 1);
    create_inverse_covariance_matrix(sigma_x_x_inv1, 1, 1);
    create_inverse_covariance_matrix(sigma_x_x_inv2, 2, 1);
    create_inverse_covariance_matrix(sigma_x_x_inv3, 3, 1);
    create_inverse_covariance_matrix(sigma_x_x_inv4, 4, 1);
    create_inverse_covariance_matrix(sigma_x_x_inv5, 5, 1);
  }
  double** sigma_x_x_inv=0;
  switch(nparam)
  {
    case 0: 
      sigma_x_x_inv = sigma_x_x_inv0; 
      break;
    case 1: 
      sigma_x_x_inv = sigma_x_x_inv1; 
      break;
    case 3: 
      sigma_x_x_inv = sigma_x_x_inv3; 
      break;
    case 2: 
      sigma_x_x_inv = sigma_x_x_inv2; 
      break;
    case 4: 
      sigma_x_x_inv = sigma_x_x_inv4; 
      break;
    case 5: 
      sigma_x_x_inv = sigma_x_x_inv5; 
      break;
    default:
      log_fatal("input nparam = %d (max = %d)", nparam, tinkerEmuParam.tinker_hmf_nparam);
      exit(0);
  }
  double result=0;
  for (int i=0; i<tinkerEmuParam.tinker_hmf_nsamp; ++i)
  {
    double temp = 0;
    for (int j=0; j<tinkerEmuParam.tinker_hmf_nsamp; ++j)
    {
      temp += (sigma_x_x_inv)[i][j]*emu_tinker_hmf_y[j][nparam]; 
    }
    temp *= kernel(cos, emu_tinker_hmf_cosmopars[i], emu_tinker_hmf_log_lambda[nparam], 
      tinkerEmuParam.tinker_hmf_ncosmo);
    result += temp;
  }
  result += emu_tinker_hmf_ymean[nparam];
  return result;
}

void emulate_all(const double *const cos, double *const ystar, const int type)
{
  int nparam;
  switch(type)
  {
    case 0: // bias emulator 
      nparam = tinkerEmuParam.tinker_bias_nparam;
      break;
    case 1: // hmf emulator
      nparam = tinkerEmuParam.tinker_hmf_nparam;
      break;
    default: 
      log_fatal("unkown type value %d (0 [bias emulator] or 1 [hmf emulator] supported)", type);
      exit(1);
  }
    
  double* yin = (double*) malloc(sizeof(double)*nparam);
  for (int i=0; i<nparam; ++i)
  {
    if (type == 0) 
    {
      yin[i] = bias_emulate_single_param(cos, i);
    }
    else if (type == 1) 
    {
      yin[i] = hmf_emulate_single_param(cos, i);
    }
    else
    {
      log_fatal("unkown type value %d (0 [bias emulator] or 1 [hmf emulator] supported)", type);
      exit(1);
    }
  }
  for (int i=0; i<nparam; ++i) //rotate
  {
    ystar[i] = 0;
    for (int j=0; j<nparam; ++j)
    {
      if (type == 0) 
      {
        ystar[i] += emu_tinker_bias_rotation_matrix[i][j]*yin[j];
      }
      if (type == 1) 
      {
        ystar[i] += emu_tinker_hmf_rotation_matrix[i][j]*yin[j];
      }
    }
  }   
  free(yin);
}

// ------------------------------------------------------------------------------------------
// ------------------------------------------------------------------------------------------
// ------------------------------------------------------------------------------------------
// Predict tinker parameters
// ------------------------------------------------------------------------------------------
// ------------------------------------------------------------------------------------------
// ------------------------------------------------------------------------------------------

void predict_tinker_bias_parameters(const double ombh2, const double omch2, const double w0, 
  const double n_s, const double H0, const double ln_10_10_A_s, const double N_eff,  
  const double redshift, double *const emu_tinker_bias_param)
{
  static cosmopara C;
  static double* ystar= 0;
  if (ystar == 0) 
  {
    ystar = (double*) malloc(sizeof(double)*tinkerEmuParam.tinker_bias_nparam);
  }
  if (recompute_cosmo3D(C))
  {
    double cosmo_emu[7] = {ombh2, omch2, w0, n_s, H0, ln_10_10_A_s, N_eff};
    emulate_all(cosmo_emu, ystar, 0);
    update_cosmopara(&C);
  }
  const double x = 1. / (1. + redshift) - 0.5;
  const double A0 = 4.2828605;
  const double a0 = 0.4722138;
  const double b0 = 1.5170196;
  const double C0 = 0.888452;
  const double a1 = -0.56318698;
  const double b1 = -0.63010135;
  const double C1 = -0.5956625;
  const double c1 = -1.85148405;
  emu_tinker_bias_param[0] = A0 + x * ystar[2];
  emu_tinker_bias_param[1] = a0 + x * a1;
  emu_tinker_bias_param[2]= ystar[0] + x * ystar[3];
  emu_tinker_bias_param[3] = b0 + x * b1;
  emu_tinker_bias_param[4]= C0 + x * C1;
  emu_tinker_bias_param[5] = ystar[1] + x * c1;
}

void predict_tinker_hmf_parameters(const double ombh2, const double omch2, const double w0, 
  const double n_s, const double H0, const double ln_10_10_A_s, const double N_eff,  
  const double redshift, double *const emu_tinker_hmf_param)
{
  static cosmopara C;
  static double* ystar= 0;
  if (ystar == 0) 
  {
    ystar = (double*) malloc(sizeof(double)*tinkerEmuParam.tinker_hmf_nparam);
  }
  if (recompute_cosmo3D(C))
  {
    double cosmo_emu[7] = {ombh2, omch2, w0, n_s, H0, ln_10_10_A_s, N_eff};
    emulate_all(cosmo_emu, ystar, 0);
    update_cosmopara(&C);
  }
  const double x = 1. / (1. + redshift) - 0.5;
  const double d0 = 2.39279115;
  const double f1 =  0.11628991;
  emu_tinker_hmf_param[0] = d0 + x * ystar[3];        //d
  emu_tinker_hmf_param[1] = ystar[0] + x * ystar[4];  //e
  emu_tinker_hmf_param[2] = ystar[1] + x * f1;        //f
  emu_tinker_hmf_param[3] = ystar[2] + x * ystar[5];  //g
}

// ------------------------------------------------------------------------------------------
// ------------------------------------------------------------------------------------------
// ------------------------------------------------------------------------------------------
// halomass function routine
// ------------------------------------------------------------------------------------------
// ------------------------------------------------------------------------------------------
// ------------------------------------------------------------------------------------------

double tinker_emulator_fnu_tinker(const double n, const double a, const double *const cosmo)
{ 
  double emu_param[4]; // d, e, f, g in eq 2 of 1804.05866
  predict_tinker_hmf_parameters(cosmo[0], cosmo[1], cosmo[2], cosmo[3], cosmo[4], cosmo[5],
    cosmo[6], 1.0/a - 1.0, emu_param);
  
  const double sigma = delta_c(a)/n; 
  
  const double B = 2.0/(pow(emu_param[1],emu_param[0])*pow(emu_param[3],-1*emu_param[0]/2)*
    gsl_sf_gamma(emu_param[0]/2.) + pow(emu_param[3], -1*emu_param[2]/2.)*
    gsl_sf_gamma(emu_param[2]/2.));

  return B*(pow((sigma/emu_param[1]), -1*emu_param[0])+pow(sigma, -1*emu_param[2]))*exp(-1*emu_param[3]/sigma/sigma);
}

double tinker_emulator_massfunc_emuonly(double m, double a, const double *const cosmo_in)
{
  return tinker_emulator_fnu_tinker(nu(m,a),a, cosmo_in)*cosmology.rho_crit*
    cosmology.Omega_m/m/m*dlognudlogm(m);
}

double calculate_chisq(const double *const cosmo_in)
{
  double* target = emu_tinker_cosmopars_mean;
  double (*invcov)[6] = emu_tinker_inv_covariance_cosmosample;
  double chisq = 0;
  for (int i=0; i<6; ++i)
  {
    double temp = 0;
    for (int j=0; j<6; ++j)
    {
      temp += invcov[i][j]*(cosmo_in[j] - target[j]);
    }
    chisq += (cosmo_in[i] - target[i])*temp;
  }
  return chisq;
}

void get_cloest_parametes(const double *const target, const double *const current, 
  double* result, const double chisq_goal, const double chisq_original, const int ndim)
{    
  for (int i=0; i<ndim; ++i)
  {
    result[i] = target[i] + pow(chisq_goal/chisq_original, 0.5)*(current[i] - target[i]);
  }
}

double tinker_emulator_massfunc(const double m, const double a) // Neff hardcoded 
{
  double cosmo_in[7] = {cosmology.Omega_b*cosmology.h0*cosmology.h0,
    (cosmology.Omega_m - cosmology.Omega_b)*cosmology.h0*cosmology.h0, cosmology.w0,
    cosmology.n_s, log(pow(10.0, 10)*cosmology.A_s), 100.0*cosmology.h0, 3.04 /* N_eff */};
  
  const int incut = tinkerEmuParam.tinker_hmf_extrapolation_cut_in;
  const int outcut = tinkerEmuParam.tinker_hmf_extrapolation_cut_out;
  const double chisq = calculate_chisq(cosmo_in); 
        
  if (chisq < incut)
  {
    return tinker_emulator_massfunc_emuonly(m,a, cosmo_in); 
  }
  else if (chisq > outcut) 
  {
    return massfunc(m,a);
  } 
  else
  {
    double cosmo_inner[7];
    double cosmo_outter[7];
    get_cloest_parametes(emu_tinker_cosmopars_mean, cosmo_in, cosmo_outter, outcut, chisq, 6);
    get_cloest_parametes(emu_tinker_cosmopars_mean, cosmo_in, cosmo_inner, incut, chisq, 6);
    return (chisq - incut)/(outcut - incut)*massfunc(m, a) + 
      (outcut - chisq)/(outcut - incut)*tinker_emulator_massfunc_emuonly(m, a, cosmo_in);
  }
}

double tinker_emulator_B1_emuonly(const double m, const double a, const double *const cosmo) 
{ // bias rountine 
  double emu_param[6]; // A, a, B, b, C, c, in eq 7 of 1907.13167
  predict_tinker_bias_parameters(cosmo[0], cosmo[1], cosmo[2], cosmo[3], cosmo[4], cosmo[5], 
    cosmo[6], 1.0/a - 1.0, emu_param);
  
  const double n = nu(m,a);
  
  return 1.0 - emu_param[0]*pow(n, emu_param[1])/(pow(n, emu_param[1]) + 
    pow(delta_c(a), emu_param[1]))+emu_param[2]*pow(n, emu_param[3]) + 
    emu_param[4]*pow(n,emu_param[5]);
}

double tinker_emulator_B1(const double m, const double a)
{
  double cosmo_in[7] = {cosmology.Omega_b*cosmology.h0*cosmology.h0,
    (cosmology.Omega_m - cosmology.Omega_b)*cosmology.h0*cosmology.h0, cosmology.w0,
     cosmology.n_s, log(pow(10.0, 10)*cosmology.A_s), 100.0*cosmology.h0, 3.04 /* N_eff */};

  const int incut = tinkerEmuParam.tinker_bias_extrapolation_cut_in;
  const int outcut = tinkerEmuParam.tinker_bias_extrapolation_cut_out;
  const double chisq = calculate_chisq(cosmo_in); 
  if (chisq < incut)
  {
    return tinker_emulator_B1_emuonly(m, a, cosmo_in); 
  }
  else if (chisq > outcut) 
  {
    return B1(m, a); 
  }
  else
  {
    double cosmo_inner[7];
    double cosmo_outter[7];
    get_cloest_parametes(emu_tinker_cosmopars_mean, cosmo_in, cosmo_outter, outcut, chisq, 6);
    get_cloest_parametes(emu_tinker_cosmopars_mean, cosmo_in, cosmo_inner, incut, chisq, 6);
    
    return (chisq - incut)/(outcut - incut)*B1(m, a) 
      + (outcut - chisq)/(outcut - incut)*tinker_emulator_B1_emuonly(m, a, cosmo_in);
  }
}